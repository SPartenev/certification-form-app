# Архитектура и реализация на Certification Form App

## Общ преглед

Next.js 15 приложение за управление на заявки за сертификация по различни ISO стандарти. Приложението поддържа двуезичност (български/английски) и интеграция с n8n за автоматизация на процесите.

## Технологичен стек

- **Framework**: Next.js 15.2.4 (App Router)
- **Language**: TypeScript 5
- **Styling**: Tailwind CSS 4.1.9
- **UI Components**: Radix UI (shadcn/ui компоненти)
- **State Management**: React Hooks (useState)
- **Form Handling**: React Hook Form 7.60.0
- **Validation**: Zod 3.25.67
- **Icons**: Lucide React
- **Fonts**: Geist Sans/Mono

## Структура на проекта

### Основни директории

```
certification-form-INSERT/
├── app/                    # Next.js App Router
│   ├── api/submit/         # API endpoint за изпращане на формата
│   ├── layout.tsx          # Root layout с LanguageProvider
│   ├── page.tsx            # Главна страница
│   └── globals.css         # Глобални стилове
├── components/             # React компоненти
│   ├── certification-form.tsx  # Главна форма (2272 реда)
│   ├── language-selector.tsx   # Селектор за език
│   ├── theme-provider.tsx      # Theme provider
│   └── ui/                # shadcn/ui компоненти (50+ компонента)
├── contexts/               # React Contexts
│   └── LanguageContext.tsx    # Контекст за интернационализация (912 реда)
├── hooks/                  # Custom hooks
├── lib/                    # Utilities
│   └── utils.ts           # Helper функции
└── public/                 # Статични файлове
```

## Ключови компоненти

### 1. LanguageContext ([contexts/LanguageContext.tsx](contexts/LanguageContext.tsx))

**Роля**: Централизирано управление на интернационализацията

**Функционалности**:

- Съхранява всички преводи за български (`bg`) и английски (`en`)
- Предоставя `useLanguage()` hook с:
  - `language`: текущ език ('bg' | 'en')
  - `setLanguage()`: функция за промяна на езика
  - `t(key)`: функция за получаване на превод по ключ
- 900+ преводни ключа, организирани по секции:
  - `form.*` - основни форми
  - `section.*` - секции на формата
  - `iso45001.*`, `iso14001.*`, `iso27001.*`, `iso37001.*`, `iso39001.*`, `iso22000.*` - специфични за стандарти
  - `company.*`, `scope.*`, `transfer.*`, `integrated.*` - други секции

**Реализация**:

```typescript
const translations = {
  bg: { /* български преводи */ },
  en: { /* английски преводи */ }
}
```

### 2. CertificationForm ([components/certification-form.tsx](components/certification-form.tsx))

**Роля**: Главна форма за сертификация (2272 реда)

**Основни функции**:

#### State Management

- `formData`: Комплексен обект с всички данни от формата
  - `applicationTypes`: масив от избрани типове заявки
  - `standards`: масив от избрани ISO стандарти
  - `sites`: масив от площадки
  - `iso45001`, `iso14001`, `iso27001`, `iso22000`, `iso39001`, `iso37001`: специфични данни за всеки стандарт
  - `transfer`, `integrated`: данни за трансфер и интегрирани системи

#### translateFormData()

Преобразува всички данни от формата в български преди изпращане:

- Стандарти: `"iso9001"` → `"ISO 9001:2015"`
- Видове площадки: `"additional"` → `"Допълнителна"`
- Език на одита: `"bulgarian"` → `"Български"`
- Да/Не отговори: `"yes"` → `"Да"`
- ISO 27001 категории: `"critical"` → `"Критичен"`
- Генерира `selectedSchemes` масив със схемите на стандартите

#### handleSubmit()

1. Валидира задължителни полета
2. Извиква `translateFormData()` за преобразуване
3. Изпраща POST заявка към `/api/submit`
4. Показва success/error модални прозорци
5. Презарежда страницата при успех

#### Conditional Rendering

Секциите се показват динамично според:

- Избрани стандарти: `formData.standards.includes("iso45001")`
- Тип заявка: `formData.applicationTypes.includes(t('application.transfer'))`
- Множество площадки: `formData.sites.length > 1`

### 3. LanguageSelector ([components/language-selector.tsx](components/language-selector.tsx))

**Роля**: UI компонент за избор на език

**Реализация**:

- Използва `Select` от shadcn/ui
- Показва "БГ" и "EN" вместо пълни имена
- Оранжев дизайн (`bg-orange-50`, `border-orange-200`)
- Globe икона от Lucide React
- Ширина: 140px

### 4. API Route ([app/api/submit/route.ts](app/api/submit/route.ts))

**Роля**: Backend endpoint за обработка на формата

**Функционалности**:

1. Получава JSON данни от клиента
2. Генерира уникален `applicationId` (`CERT-${Date.now()}`)
3. Добавя metadata:
   - `submittedAt`: ISO timestamp
   - `submittedBy`: попълнил формата
   - `organizationName`, `eik`
   - `formVersion`: '1.0'
   - `applicationId`
4. Изпраща към n8n webhook (ако е настроен `N8N_WEBHOOK_URL`)
5. Връща JSON отговор с `success`, `message`, `id`

**Error Handling**:

- Грешки с n8n не спират процеса (продължава въпреки тях)
- Връща 500 при критични грешки

## Поток на данни

```
User Input → formData State → handleSubmit() 
  → translateFormData() → POST /api/submit 
    → API Route → n8n Webhook → Response → Success Modal
```

### Детайли на потока:

1. **Потребител попълва формата**

   - Всички промени се записват в `formData` чрез `setFormData()`

2. **При натискане на "Изпрати заявката"**

   - `handleSubmit()` се извиква
   - Валидация на задължителни полета
   - `translateFormData()` преобразува всички стойности в български

3. **Изпращане към API**

   - POST заявка към `/api/submit`
   - Body: `submissionData` (включва `translatedFormData`)

4. **API обработка**

   - Генерира `applicationId`
   - Добавя metadata
   - Изпраща към n8n webhook (ако е настроен)

5. **Отговор към клиента**

   - Success: показва модал с номер на заявката
   - Error: показва грешка

## Поддържани ISO стандарти

1. **ISO 9001:2015** - Качество
2. **ISO 14001:2015** - Околна среда
3. **ISO 22000:2018** - Хранителна безопасност
4. **ISO 27001:2022** - Информационна сигурност
5. **ISO 37001:2016** - Борба с подкупването
6. **ISO 37001:2025** - Борба с подкупването (нова версия)
7. **ISO 39001:2012** - Пътна безопасност
8. **ISO 45001:2018** - Охрана на труда
9. **Други стандарти** - Свободен текст

## Типове заявки

- Първоначална сертификация (`new`)
- Подновяване (`renewal`)
- Трансфер (`transfer`) - показва специална секция
- Разширяване на обхвата (`change`)

## Специфични секции

### Scope of Certification

- Множество площадки с адрес, процеси, служители, тип (Основна/Допълнителна)
- Multi-site Management - 7 опции за управление на множество площадки

### ISO 37001 (Борба с подкупването)

- Чувствителни процеси с брой служители
- Площадки с детайлна информация
- Допълнителни полета за контролирани/контролиращи юридически лица
- Независима проверка текст
- Въпроси за разследвания и публични приходи

### ISO 27001 (Информационна сигурност)

- 6 категории с различни опции
- Категории служители (достъп само за четене, без физически достъп, ограничен достъп, пълен достъп)

### Transfer Section

- Показва се само при избор на "Трансфер"
- Полета за валиден сертификат, причини, оплаквания, нормативни изисквания
- Чекбоксове за приложени документи

## UI/UX характеристики

- **Responsive дизайн** с Tailwind CSS
- **Card-based layout** - всяка секция е в `Card` компонент
- **Оранжева цветова схема** - `bg-orange-50`, `border-orange-200` за акценти
- **Stone цветова палитра** - `bg-stone-50`, `text-stone-800` за основен фон
- **Икони от Lucide React** - Building2, Shield, Leaf, Lock, Utensils, Car, AlertTriangle
- **Модални прозорци** - за success/error съобщения (използва `alert()`)

## Environment Variables

```env
N8N_WEBHOOK_URL=https://n8n_test.i-love-ai.fun
```

## Build Configuration

- **Output**: `standalone` (за deployment)
- **TypeScript**: игнорира build errors (`ignoreBuildErrors: true`)
- **ESLint**: игнорира по време на build (`ignoreDuringBuilds: true`)
- **Images**: unoptimized (за Vercel Blob Storage)

## Особености на реализацията

1. **Превод преди изпращане**: Всички данни се преобразуват в български преди изпращане към n8n
2. **Динамични секции**: Секциите се показват/скриват според избрани стандарти и типове заявки
3. **Комплексна форма**: 2000+ реда код за управление на множество стандарти и полета
4. **Type Safety**: Пълна TypeScript типизация на всички данни
5. **Модулна структура**: UI компоненти от shadcn/ui за консистентен дизайн

## Детайли на реализацията

### Превод на данни

Функцията `translateFormData()` в `certification-form.tsx` преобразува всички стойности от формата в български преди изпращане. Това включва:

- **Стандарти**: Преобразуване на ключове (`"iso9001"`) в пълни имена (`"ISO 9001:2015"`)
- **Схеми**: Генериране на масив `selectedSchemes` със схемите на избраните стандарти
- **Видове площадки**: `"main"` → `"Основна"`, `"additional"` → `"Допълнителна"`
- **Език на одита**: `"bulgarian"` → `"Български"`, `"english"` → `"Английски"`
- **Да/Не отговори**: `"yes"` → `"Да"`, `"no"` → `"Не"`
- **ISO 27001 категории**: Преобразуване на всички 6 категории с техните опции

### Управление на състоянието

Приложението използва React `useState` hook за управление на състоянието. Основният обект `formData` съдържа:

- **Прост тип данни**: strings, numbers, booleans
- **Масиви**: `applicationTypes`, `standards`, `sites`, `multiSiteManagement`
- **Вложени обекти**: `iso45001`, `iso14001`, `iso27001`, `iso22000`, `iso39001`, `iso37001`
- **Комплексни структури**: `sites` масив с обекти, `iso37001.sites` масив с обекти

### Валидация

Валидацията се извършва в `handleSubmit()` преди изпращане:

- Проверка за избран поне един тип заявка
- Проверка за попълнен език на одита
- Допълнителни валидации могат да се добавят в бъдеще

### Интеграция с n8n

API route-ът изпраща данните към n8n webhook чрез POST заявка. Структурата на данните включва:

- Оригиналните данни от формата
- Преведените данни (`translatedFormData`)
- Metadata с информация за заявката
- Application ID за проследяване

### Условно рендиране

Секциите се показват/скриват базирано на:

- **Избрани стандарти**: Всяка секция за стандарт се показва само ако стандартът е избран
- **Тип заявка**: Секцията "Трансфер" се показва само при избор на "Трансфер"
- **Брой площадки**: Секцията "Multi-site Management" се показва само ако има повече от една площадка

## Разширяване на функционалността

### Добавяне на нов стандарт

1. Добави преводи в `LanguageContext.tsx` за новия стандарт
2. Добави нов обект в `FormData` interface
3. Добави инициализация в `useState`
4. Добави секция в JSX с условно рендиране
5. Добави преобразуване в `translateFormData()`

### Добавяне на нов език

1. Добави нов ключ в `translations` обект в `LanguageContext.tsx`
2. Добави опция в `LanguageSelector`
3. Актуализирай `Language` type за новия език

### Модифициране на API endpoint

API route-ът може да бъде разширен с:

- Допълнителна валидация
- Записване в база данни
- Изпращане на email нотификации
- Интеграция с други системи


